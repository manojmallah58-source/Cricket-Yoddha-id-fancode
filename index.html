<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Turbo Ferrari Pro 3D</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Arial', sans-serif; }
        #ui { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; color: white; }
        .stat { position: absolute; top: 20px; font-size: 22px; font-weight: bold; background: rgba(0,0,0,0.5); padding: 10px 20px; border-radius: 30px; }
        #score-display { left: 20px; border-left: 5px solid #ff0000; }
        #coin-display { right: 20px; border-right: 5px solid #ffd700; }
        
        #overlay { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.8); display: flex; flex-direction: column;
            align-items: center; justify-content: center; display: none; pointer-events: auto;
        }
        #start-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: radial-gradient(circle, #444, #000); display: flex; 
            flex-direction: column; align-items: center; justify-content: center; pointer-events: auto;
        }
        button { 
            background: #ff4757; border: none; padding: 15px 40px; color: white; 
            font-size: 24px; border-radius: 50px; cursor: pointer; transition: 0.3s;
            box-shadow: 0 5px 15px rgba(255, 71, 87, 0.4);
        }
        button:hover { transform: scale(1.1); background: #ff6b81; }

        #mobile-controls {
            position: absolute; bottom: 30px; width: 100%; display: flex;
            justify-content: space-between; padding: 0 30px; box-sizing: border-box;
        }
        .btn {
            width: 70px; height: 70px; background: rgba(255,255,255,0.2);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 30px; pointer-events: auto; -webkit-user-select: none;
        }
    </style>
</head>
<body>

<div id="start-screen">
    <h1 style="color: #ff4757; font-size: 48px; margin-bottom: 10px;">TURBO RACER PRO</h1>
    <p style="color: #ccc; margin-bottom: 30px;">Ferrari Edition</p>
    <button onclick="startGame()">START RACE</button>
</div>

<div id="ui">
    <div id="score-display" class="stat">SCORE: 0</div>
    <div id="coin-display" class="stat">ðŸª™ <span id="coin-val">0</span></div>
    
    <div id="overlay">
        <h1 style="font-size: 50px; color: #ff4757;">CRASHED!</h1>
        <p id="final-stats" style="font-size: 20px;"></p>
        <button onclick="resetGame()">RESTART</button>
    </div>

    <div id="mobile-controls">
        <div class="btn" id="lBtn">â—€</div>
        <div class="btn" id="rBtn">â–¶</div>
    </div>
</div>

<script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.164.1/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.164.1/examples/jsm/"
        }
    }
</script>

<script type="module">
    import * as THREE from 'three';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
    import { DRACOLoader } from 'three/addons/loaders/DRACOLoader.js';

    let scene, camera, renderer, player, clock, audioListener;
    let engineSound, coinSound, crashSound;
    let score = 0, coins = 0, gameActive = false;
    const enemyCars = [], collectibles = [], decor = [];
    const keys = { left: false, right: false };

    // --- Audio Setup ---
    function initAudio() {
        audioListener = new THREE.AudioListener();
        camera.add(audioListener);

        engineSound = new THREE.Audio(audioListener);
        coinSound = new THREE.Audio(audioListener);
        crashSound = new THREE.Audio(audioListener);

        const loader = new THREE.AudioLoader();
        // Placeholder tones since we can't load external mp3 easily without CORS
        // In a real app, replace with: loader.load('path/to/engine.mp3', ...)
    }

    function playTone(freq, duration, type = 'sine') {
        const osc = audioListener.context.createOscillator();
        const gain = audioListener.context.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, audioListener.context.currentTime);
        gain.gain.setValueAtTime(0.1, audioListener.context.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.0001, audioListener.context.currentTime + duration);
        osc.connect(gain);
        gain.connect(audioListener.context.destination);
        osc.start();
        osc.stop(audioListener.context.currentTime + duration);
    }

    // --- Game Logic ---
    function init() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x111111);
        scene.fog = new THREE.Fog(0x111111, 20, 150);

        camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 4, 8);
        camera.lookAt(0, 1, -5);

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        clock = new THREE.Clock();

        const light = new THREE.DirectionalLight(0xffffff, 1.5);
        light.position.set(5, 10, 5);
        light.castShadow = true;
        scene.add(light);
        scene.add(new THREE.AmbientLight(0xffffff, 0.4));

        createRoad();
        loadPlayer();
        spawnTraffic();
        spawnCoins();
        initAudio();

        window.addEventListener('resize', onWindowResize);
        setupInput();
    }

    function createRoad() {
        // Main Road
        const roadGeo = new THREE.PlaneGeometry(12, 1000);
        const roadMat = new THREE.MeshStandardMaterial({ color: 0x222222 });
        const road = new THREE.Mesh(roadGeo, roadMat);
        road.rotation.x = -Math.PI / 2;
        road.receiveShadow = true;
        scene.add(road);

        // Grid/Lane Lines
        for(let i=0; i<40; i++) {
            const line = new THREE.Mesh(new THREE.PlaneGeometry(0.2, 3), new THREE.MeshBasicMaterial({color: 0xffffff}));
            line.rotation.x = -Math.PI/2;
            line.position.set(0, 0.05, -i * 10);
            scene.add(line);
            decor.push(line);
        }
    }

    function loadPlayer() {
        const loader = new GLTFLoader();
        const draco = new DRACOLoader();
        draco.setDecoderPath('https://www.gstatic.com/draco/versioned/decoders/1.5.7/');
        loader.setDRACOLoader(draco);

        loader.load('https://threejs.org/examples/models/gltf/ferrari.glb', (gltf) => {
            player = gltf.scene;
            player.scale.set(1, 1, 1);
            player.rotation.y = Math.PI;
            player.traverse(c => { if(c.isMesh) c.castShadow = true; });
            scene.add(player);
        });
    }

    function spawnTraffic() {
        const colors = [0x3498db, 0x2ecc71, 0xf1c40f, 0x9b59b6];
        for(let i=0; i<4; i++) {
            const car = new THREE.Group();
            const body = new THREE.Mesh(new THREE.BoxGeometry(1.6, 0.8, 3), new THREE.MeshStandardMaterial({color: colors[i]}));
            body.position.y = 0.4;
            car.add(body);
            resetObject(car, true);
            scene.add(car);
            enemyCars.push(car);
        }
    }

    function spawnCoins() {
        const geo = new THREE.TorusGeometry(0.4, 0.1, 8, 16);
        const mat = new THREE.MeshStandardMaterial({color: 0xffd700, metalness: 1, roughness: 0.3});
        for(let i=0; i<5; i++) {
            const coin = new THREE.Mesh(geo, mat);
            resetObject(coin, false);
            scene.add(coin);
            collectibles.push(coin);
        }
    }

    function resetObject(obj, isCar) {
        obj.position.z = -100 - (Math.random() * 100);
        obj.position.x = (Math.random() - 0.5) * 10;
        if(!isCar) obj.position.y = 0.8;
    }

    function update(delta) {
        if(!gameActive || !player) return;

        const speed = 50 * delta;
        
        // Input
        if(keys.left && player.position.x > -5) player.position.x -= 15 * delta;
        if(keys.right && player.position.x < 5) player.position.x += 15 * delta;

        // Environment Move
        decor.forEach(item => {
            item.position.z += speed;
            if(item.position.z > 20) item.position.z = -100;
        });

        // Traffic Move
        enemyCars.forEach(car => {
            car.position.z += speed * 0.6;
            if(car.position.z > 15) resetObject(car, true);
            
            // Collision
            if(Math.abs(player.position.z - car.position.z) < 2.5 && Math.abs(player.position.x - car.position.x) < 1.5) {
                gameOver();
            }
        });

        // Coins
        collectibles.forEach(coin => {
            coin.position.z += speed;
            coin.rotation.y += 2 * delta;
            if(coin.position.z > 15) resetObject(coin, false);

            if(Math.abs(player.position.z - coin.position.z) < 1.5 && Math.abs(player.position.x - coin.position.x) < 1.2) {
                coins++;
                score += 50;
                playTone(800, 0.1, 'square'); // Coin Sound
                resetObject(coin, false);
                document.getElementById('coin-val').innerText = coins;
            }
        });

        score += Math.floor(delta * 10);
        document.getElementById('score-display').innerText = `SCORE: ${score}`;
    }

    function gameOver() {
        gameActive = false;
        playTone(100, 0.5, 'sawtooth'); // Crash Sound
        document.getElementById('overlay').style.display = 'flex';
        document.getElementById('final-stats').innerText = `Score: ${score} | Coins: ${coins}`;
    }

    window.startGame = function() {
        document.getElementById('start-screen').style.display = 'none';
        gameActive = true;
        playTone(200, 0.2); // Start Sound
    }

    window.resetGame = function() {
        score = 0; coins = 0;
        document.getElementById('coin-val').innerText = "0";
        document.getElementById('overlay').style.display = 'none';
        player.position.x = 0;
        enemyCars.forEach(c => resetObject(c, true));
        collectibles.forEach(c => resetObject(c, false));
        gameActive = true;
    }

    function setupInput() {
        window.addEventListener('keydown', e => {
            if(e.key === 'ArrowLeft') keys.left = true;
            if(e.key === 'ArrowRight') keys.right = true;
        });
        window.addEventListener('keyup', e => {
            if(e.key === 'ArrowLeft') keys.left = false;
            if(e.key === 'ArrowRight') keys.right = false;
        });

        const l = document.getElementById('lBtn');
        const r = document.getElementById('rBtn');
        const startL = (e) => { e.preventDefault(); keys.left = true; };
        const stopL = () => keys.left = false;
        const startR = (e) => { e.preventDefault(); keys.right = true; };
        const stopR = () => keys.right = false;

        l.addEventListener('touchstart', startL); l.addEventListener('touchend', stopL);
        r.addEventListener('touchstart', startR); r.addEventListener('touchend', stopR);
        l.addEventListener('mousedown', startL); l.addEventListener('mouseup', stopL);
        r.addEventListener('mousedown', startR); r.addEventListener('mouseup', stopR);
    }

    function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function animate() {
        requestAnimationFrame(animate);
        update(clock.getDelta());
        renderer.render(scene, camera);
    }

    init();
    animate();
</script>
</body>
</html>



